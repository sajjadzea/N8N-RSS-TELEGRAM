# 📚 Workflow استخراج موضوعات تحقیقاتی آبفای مشهد

این workflow برای استخراج خودکار موضوعات تحقیقاتی از سایت آبفای مشهد و ارسال آن‌ها به تلگرام طراحی شده است.

## 🎯 قابلیت‌ها

- ✅ استخراج خودکار داده‌ها از سایت `https://research.abfamashhad.ir/SubjectsList`
- ✅ پارس کردن جدول HTML و استخراج اطلاعات:
  - عنوان موضوع
  - نوع (پایان‌نامه کارشناسی ارشد، دکتری و...)
  - مهلت ثبت پروپوزال
  - جزئیات
- ✅ **تشخیص هوشمند تغییرات:**
  - شناسایی موضوعات جدید
  - تشخیص تغییر در مهلت ثبت پروپوزال
  - تشخیص تغییر در نوع و جزئیات
  - نمایش مقایسه قبل/بعد برای تغییرات
- ✅ فرمت‌بندی زیبا با فونت فارسی و ایموجی
- ✅ ارسال به کانال تلگرام
- ✅ اجرای خودکار هر 6 ساعت
- ✅ ذخیره‌سازی دائمی داده‌ها برای مقایسه

## ⚙️ نحوه راه‌اندازی

### 1. Import کردن Workflow

1. فایل `Research_Subjects_Scraper_Telegram.json` را باز کنید
2. محتوای آن را کپی کنید
3. در n8n به قسمت Workflows بروید
4. روی دکمه Import کلیک کنید
5. محتوا را Paste کنید

### 2. تنظیم Telegram Bot

قبل از استفاده، باید:

1. **ایجاد Bot تلگرام:**
   - به [@BotFather](https://t.me/botfather) در تلگرام پیام دهید
   - دستور `/newbot` را ارسال کنید
   - نام و username برای bot خود انتخاب کنید
   - Token دریافتی را کپی کنید

2. **دریافت Chat ID:**
   - Bot را به کانال خود اضافه کنید و Admin کنید
   - یا از [@userinfobot](https://t.me/userinfobot) برای دریافت Chat ID شخصی استفاده کنید
   - برای کانال، معمولاً Chat ID به صورت `-100xxxxxxxxxx` است

3. **تنظیم Credentials در n8n:**
   - در n8n به قسمت Credentials بروید
   - یک Telegram API credential جدید ایجاد کنید
   - Token بات را وارد کنید

4. **به‌روزرسانی Workflow:**
   - Node "Send to Telegram" را باز کنید
   - در قسمت `chatId` شناسه کانال یا چت خود را وارد کنید
   - Credential تلگرام خود را انتخاب کنید

### 3. تنظیم زمان‌بندی (اختیاری)

Node "Every 6 Hours" را می‌توانید تنظیم کنید:
- هر ساعت
- هر روز
- یا هر بازه زمانی دلخواه

### 4. فعال‌سازی Workflow

- روی دکمه "Active" در بالای صفحه کلیک کنید
- Workflow به‌طور خودکار در زمان‌های تعیین‌شده اجرا می‌شود

## 🧪 تست Workflow

برای تست دستی:
1. روی node "Every 6 Hours" کلیک راست کنید
2. گزینه "Execute Node" را انتخاب کنید
3. منتظر بمانید تا تمام nodeها اجرا شوند
4. نتایج را در تلگرام بررسی کنید

## 📋 ساختار Workflow

```
Every 6 Hours
    ↓
Fetch Research Subjects Page (HTTP Request)
    ↓
Parse HTML & Extract Data (Code)
    ↓
Detect Changes (Code) ← مقایسه با داده‌های قبلی
    ↓
Format Telegram Messages (Code) ← ساخت پیام برای موارد جدید/تغییر یافته
    ↓
Should Send? (IF)
    ↓
Wait Between Messages (Wait)
    ↓
Send to Telegram (Telegram)
```

### نحوه کار تشخیص تغییرات:

1. **اولین اجرا:** تمام موضوعات به عنوان "جدید" شناخته می‌شوند و ارسال می‌شوند
2. **اجراهای بعدی:**
   - موضوعاتی که عنوان جدید دارند → پیام "موضوع جدید"
   - موضوعاتی که فیلدهایشان تغییر کرده → پیام "به‌روزرسانی" با نمایش تغییرات
   - موضوعات بدون تغییر → پیام ارسال نمی‌شود

## 🎨 فرمت پیام‌ها

### پیام خلاصه (ابتدای هر به‌روزرسانی):
```
🔔 به‌روزرسانی موضوعات تحقیقاتی — آبفای مشهد

🆕 موضوعات جدید: ۲
🔄 موضوعات به‌روزرسانی شده: ۱

📅 زمان بررسی: ۱۴۰۳/۰۸/۱۰ ۱۴:۳۰

در پیام‌های بعدی جزئیات ارسال می‌شود.
```

### پیام موضوع جدید:
```
🆕 موضوع تحقیقاتی جدید

📌 عنوان:
[عنوان موضوع]

🎓 نوع:
[نوع تحقیق]

⏰ مهلت ثبت پروپوزال:
[تاریخ به فارسی]

📋 جزئیات:
[جزئیات موضوع]

🔗 مشاهده در سایت

🤖 موضوع جدید شماره ۱ از ۲
```

### پیام به‌روزرسانی موضوع:
```
🔄 به‌روزرسانی موضوع تحقیقاتی

📌 عنوان:
[عنوان موضوع]

✏️ تغییرات:

▫️ مهلت ثبت پروپوزال
   قبلی: ۱۴۰۳/۰۸/۱۵
   جدید: ۱۴۰۳/۰۹/۰۱ ✨

📊 اطلاعات کامل فعلی:

🎓 نوع: پایان‌نامه کارشناسی ارشد
⏰ مهلت: ۱۴۰۳/۰۹/۰۱
📋 جزئیات: جزئیات موضوع

🔗 مشاهده در سایت

🤖 به‌روزرسانی شماره ۱ از ۱
```

### زمانی که تغییری نباشد:
```
✅ بررسی انجام شد

هیچ موضوع جدید یا به‌روزرسانی یافت نشد.
```

## 🔧 سفارشی‌سازی

### تغییر Headers

اگر سایت مسدود شد، می‌توانید در node "Fetch Research Subjects Page" Headers را تغییر دهید:
- User-Agent
- Accept-Language
- و سایر headerها

### تغییر پارسر HTML

در node "Parse HTML & Extract Data" می‌توانید:
- الگوی regex را برای استخراج داده‌ها تغییر دهید
- ستون‌های جدید اضافه کنید
- فرمت خروجی را تنظیم کنید

### تغییر فرمت پیام

در node "Format Telegram Messages":
- ایموجی‌ها را تغییر دهید
- فرمت‌بندی Markdown را شخصی‌سازی کنید
- فیلدهای جدید اضافه کنید

## ⚠️ نکات مهم

1. **ذخیره‌سازی داده‌ها:**
   - Workflow از **Workflow Static Data** برای ذخیره‌سازی دائمی استفاده می‌کند
   - داده‌ها حتی بعد از restart کردن n8n حفظ می‌شوند
   - برای reset کردن داده‌ها و شروع مجدد، workflow را غیرفعال و دوباره فعال کنید

2. **تشخیص تغییرات:**
   - تشخیص بر اساس **عنوان موضوع** انجام می‌شود (به عنوان کلید یکتا)
   - اگر عنوانی تغییر کند، به عنوان موضوع جدید شناخته می‌شود
   - تغییرات در نوع، مهلت و جزئیات به طور جداگانه ردیابی می‌شوند

3. **محدودیت Rate Limiting:**
   - Node "Wait Between Messages" برای جلوگیری از محدودیت تلگرام 2 ثانیه تاخیر دارد
   - اگر تعداد پیام‌ها زیاد است، این مقدار را افزایش دهید

4. **بررسی ساختار سایت:**
   - اگر سایت تغییر کرد، باید Code node پارسر را به‌روزرسانی کنید
   - ابتدا صفحه HTML را دستی بررسی کنید

5. **امنیت:**
   - Token تلگرام خود را محفوظ نگه دارید
   - از Credentials n8n به جای hard-coding استفاده کنید

## 🐛 عیب‌یابی

### پیام ارسال نمی‌شود
- Chat ID را بررسی کنید (باید با `-` شروع شود برای کانال)
- Bot را Admin کانال کنید
- Credentials تلگرام را چک کنید

### داده استخراج نمی‌شود
- ساختار HTML سایت را بررسی کنید
- Code node "Parse HTML & Extract Data" را debug کنید
- Headers درخواست HTTP را بررسی کنید

### تغییرات تشخیص داده نمی‌شوند
- مطمئن شوید workflow حداقل یک بار با موفقیت اجرا شده
- در node "Detect Changes" خروجی را بررسی کنید
- Workflow Static Data را چک کنید:
  - در n8n به Settings → Variables بروید
  - متغیر `researchSubjects` را پیدا کنید
- اگر داده‌ها corrupted شدند، workflow را غیرفعال و دوباره فعال کنید

### تمام موضوعات به عنوان "جدید" نمایش داده می‌شوند
- این رفتار طبیعی در اولین اجرا است
- Static Data را بررسی کنید، احتمالاً خالی است
- بعد از اولین اجرا، اجرای بعدی باید تغییرات را تشخیص دهد

### خطای 403
- User-Agent را تغییر دهید
- Headers بیشتری اضافه کنید
- از proxy استفاده کنید (در تنظیمات n8n)

## 📝 لایسنس

این workflow برای استفاده شخصی و آموزشی ارائه شده است.

## 🤝 مشارکت

برای گزارش مشکل یا پیشنهاد بهبود، Issue ایجاد کنید.

---

**ساخته شده با ❤️ برای جامعه n8n فارسی‌زبانان**
