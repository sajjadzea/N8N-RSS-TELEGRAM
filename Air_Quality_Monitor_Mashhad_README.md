# ุฑุงูููุง Workflow ฺฉูุช ููุง ูุดูุฏ (Payesh)

ุงู workflow ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ูุฑ ุณุงุนุช ุฏุงุฏูโูุง ฺฉูุช ููุง ุดูุฑ ูุดูุฏ ุฑุง ุงุฒ API ุณุงูุงูู ูพุงุด ุดูุฑ ุฏุฑุงูุช ฺฉุฑุฏู ู ุฎูุงุตูโุง ุงุฒ ูุถุนุช ุฑุง ุจู ฺฉุงูุงู ุชูฺฏุฑุงู ุงุฑุณุงู ูโฺฉูุฏ.

## ๐๏ธ ูุนูุงุฑ Workflow

```
Cron Trigger (ูุฑ ุณุงุนุช)
    โ
    โโโ> Get Dashboard (Payesh) [HTTP Request]
              โ
              โโโ> Build Telegram Message [Function]
                        โ
                        โโโ> Deduplicate / Send Control [Function]
                                  โ
                                  โโโ> Should Send? [IF]
                                           โ
                                           โโโ> Send to Telegram
```

## ๐ฆ ูพุดโูุงุฒูุง

### 1. ูุชุบุฑูุง ูุญุท

ููุท ฺฉ ูุชุบุฑ ูุญุท ูุงุฒ ุงุณุช:

```bash
TELEGRAM_CHAT_ID=@your_channel_or_chat_id
```

### 2. Telegram Bot Credentials

ุฏุฑ n8n:
1. ุจู Settings โ Credentials ุจุฑูุฏ
2. ฺฉ credential ุฌุฏุฏ ุงุฒ ููุน "Telegram API" ุงุฌุงุฏ ฺฉูุฏ
3. Access Token ุฑุจุงุช ุชูฺฏุฑุงู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ (ุงุฒ @BotFather ุฏุฑุงูุช ูโุดูุฏ)

## ๐ ูุตุจ ู ุฑุงูโุงูุฏุงุฒ

### ฺฏุงู 1: Import ฺฉุฑุฏู Workflow

1. ูุงู `Air_Quality_Monitor_Mashhad.json` ุฑุง ุฏุฑ n8n import ฺฉูุฏ
2. ุจู ูุณูุช Workflows โ Import from File ุจุฑูุฏ
3. ูุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

### ฺฏุงู 2: ุชูุธู Telegram Credentials

1. ุฑู node "Send to Telegram" ฺฉูฺฉ ฺฉูุฏ
2. Telegram Bot credential ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

### ฺฏุงู 3: ุชูุธู Chat ID

**ุฑูุด 1: ุงุณุชูุงุฏู ุงุฒ Environment Variable**

ุฏุฑ n8n:
```
TELEGRAM_CHAT_ID=@your_channel
```

**ุฑูุด 2: Hardcode ุฏุฑ workflow** (ุงฺฏุฑ ูโุฎูุงูุฏ)

ุดูุงุณู ฺฉุงูุงู/ฺุช ุฎูุฏ ุฑุง ูุณุชููุงู ุฏุฑ node "Send to Telegram" ูุงุฑุฏ ฺฉูุฏ.

### ฺฏุงู 4: ูุนุงูโุณุงุฒ

1. ุฏฺฉูู "Active" ุฑุง ุฑูุดู ฺฉูุฏ
2. Workflow ูุฑ ุณุงุนุช ุงุฌุฑุง ูโุดูุฏ

### ฺฏุงู 5: ุชุณุช

ุฑู node "Every Hour" ฺฉูฺฉ ุฑุงุณุช ฺฉุฑุฏู ู "Execute Node" ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.

## ๐ง ุชูุถุญ Nodeโูุง

### 1. Every Hour (Cron Trigger)
- **ููุน**: Schedule Trigger
- **ุชูุธูุงุช**: ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ูุฑ ุณุงุนุช
- **ุฎุฑูุฌ**: ฺฉ trigger ุจุฑุง ุดุฑูุน workflow

### 2. Get Dashboard (Payesh)
- **URL**: `https://payesh.mashhad.ir/api/Dashboard/Citizen`
- **Method**: GET
- **Authentication**: None (API ุนููู ุงุณุช)
- **Headers**:
  - `Accept: application/json`
  - `User-Agent: n8n-payesh-fetcher/1.0`
- **ุฎุฑูุฌ**: ุฏุงุฏูโูุง ฺฉุงูู Dashboard ุดุงูู:
  - `aqi`: ุดุงุฎุต ฺฉู ุดูุฑ
  - `stationsAQI`: ุขุฑุงู ุงุณุชฺฏุงูโูุง ุจุง AQI ูุฑ ฺฉุฏุงู
  - `airQualityMeasurementDateTime`: ุฒูุงู ุงูุฏุงุฒูโฺฏุฑ
  - `past24HourChanges`: ุชุบุฑุงุช 24 ุณุงุนุช ฺฏุฐุดุชู

### 3. Build Telegram Message (Function)

ุงู node:
- ุฏุงุฏูโูุง API ุฑุง ูพุฑุฏุงุฒุด ูโฺฉูุฏ
- ุงุนุฏุงุฏ ุฑุง ุจู ูุงุฑุณ ุชุจุฏู ูโฺฉูุฏ
- ุงุณุชฺฏุงูโูุง ุฑุง ุจุฑ ุงุณุงุณ AQI ูุฑุชุจ ูโฺฉูุฏ (ุจุฏุชุฑู ุงูู)
- ูพุงู Markdown ุฑุง ูโุณุงุฒุฏ

**ูุฑูุฏ**:
```json
{
  "data": {
    "aqi": 120,
    "airQualityMeasurementDateTime": "2025-10-30T09:00:00",
    "stationsAQI": [
      {
        "label": "ฺูู",
        "value": {
          "aqi": 145,
          "influetialParameter": "PM2.5",
          "dateTime": "..."
        }
      }
    ]
  }
}
```

**ุฎุฑูุฌ**:
```json
{
  "send": true,
  "message": "ูุชู ูพุงู Markdown",
  "meta": {
    "cityAqi": 120,
    "measuredAt": "2025-10-30T09:00:00"
  }
}
```

### 4. Deduplicate / Send Control (Function)

- ุงุฒ Workflow Static Data ุงุณุชูุงุฏู ูโฺฉูุฏ
- ุฒูุงู ุงูุฏุงุฒูโฺฏุฑ (`measuredAt`) ุฑุง ุจุง ุขุฎุฑู ุงุฑุณุงู ููุงุณู ูโฺฉูุฏ
- ุงฺฏุฑ ุฏุงุฏู ุฌุฏุฏ ุจุงุดุฏุ `send: true` ุจุฑูโฺฏุฑุฏุงูุฏ
- ุงุฒ ุงุฑุณุงู ุชฺฉุฑุงุฑ ููุงู ุฏุงุฏู ุฌููฺฏุฑ ูโฺฉูุฏ

### 5. Should Send? (IF)

- ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง `send === true`
- ุงฺฏุฑ true ุจุงุดุฏุ ุจู Telegram ุงุฑุณุงู ูโุดูุฏ
- ุงฺฏุฑ false ุจุงุดุฏุ workflow ูุชููู ูโุดูุฏ

### 6. Send to Telegram

- ูพุงู ุฑุง ุจู ฺฉุงูุงู/ฺุช ุงุฑุณุงู ูโฺฉูุฏ
- ุงุฒ ูุฑูุช Markdown ุงุณุชูุงุฏู ูโฺฉูุฏ
- ูพุดโููุงุด ููฺฉ ุบุฑูุนุงู ุงุณุช

## ๐ฑ ููููู ุฎุฑูุฌ

```
*ุดุงุฎุต ฺฉูุช ููุง โ ุฎูุงุตู (ูุดูุฏ)*
ุฒูุงู ุงูุฏุงุฒูโฺฏุฑ: ฑดฐด/ฐท/ณฐ ฐน:ฐฐ
ุดุงุฎุต ฺฉู ุดูุฑ: *ฑฒฐ*

*ูพูุฌ ุงุณุชฺฏุงู ุจุง ุจุฏุชุฑู ูุถุนุช:*
1. *ฺูู* โ ุดุงุฎุต: *ฑดต* โ ุขูุงูุฏู: PM2.5
2. *ูฺฉูโุขุจุงุฏ* โ ุดุงุฎุต: *ฑณธ* โ ุขูุงูุฏู: PM10
3. *ฺฉููุณูฺฏ* โ ุดุงุฎุต: *ฑฒต*
4. *ุณุฌุงุฏ* โ ุดุงุฎุต: *ฑฑธ*
5. *ุฑุณุงูุช* โ ุดุงุฎุต: *ฑฑฐ*

ุดุงุฎุต ุงุฎุฑ: ฑฒฒ

_ูพุงู ุฎูุฏฺฉุงุฑ โ ูุฑ ุณุงุนุช ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ._
```

## ๐ ุนุจโุงุจ

### ุฎุทุง: "Could not reach URL"
**ุฑุงู ุญู**:
- ุงุชุตุงู ุงูุชุฑูุช ุฑุง ุจุฑุฑุณ ฺฉูุฏ
- ููฺฉู ุงุณุช ุณุงุช payesh.mashhad.ir ูููุชุงู ุฏุฑ ุฏุณุชุฑุณ ูุจุงุดุฏ
- VPN ุฑุง ุงูุชุญุงู ฺฉูุฏ (ุงฺฏุฑ ูุงุฒู ุงุณุช)

### ุฎุทุง: "Cannot read property 'stationsAQI'"
**ุฑุงู ุญู**:
- ุณุงุฎุชุงุฑ API ุชุบุฑ ฺฉุฑุฏู ุงุณุช
- ฺฉุฏ Function ุฑุง ุจุฑุฑุณ ฺฉูุฏ
- ุฎุฑูุฌ HTTP Request ุฑุง ฺฺฉ ฺฉูุฏ

### ูพุงู ุงุฑุณุงู ููโุดูุฏ
**ุฑุงู ุญู**:
- Workflow Static Data ุฑุง ูพุงฺฉ ฺฉูุฏ
- Node "Deduplicate" ุฑุง ูููุชุงู ุญุฐู ฺฉูุฏ
- ูุณุชููุงู "Build Telegram Message" ุฑุง ุจู "Should Send?" ูุตู ฺฉูุฏ

### ุงุนุฏุงุฏ ูุงุฑุณ ููุงุด ุฏุงุฏู ููโุดููุฏ
**ุฑุงู ุญู**: ุชุงุจุน `toFaDigits` ุฏุฑ code ุฑุง ุจุฑุฑุณ ฺฉูุฏ.

## ๐๏ธ ุณูุงุฑุดโุณุงุฒ

### ุชุบุฑ ุชุนุฏุงุฏ ุงุณุชฺฏุงูโูุง ููุงุด ุฏุงุฏู ุดุฏู

ุฏุฑ node "Build Telegram Message":
```javascript
const top5 = mapped.slice(0, 5);  // ุชุบุฑ 5 ุจู ุชุนุฏุงุฏ ุฏูุฎูุงู
```

### ุชุบุฑ ูุฑูุช ูพุงู

ุฏุฑ ููุงู nodeุ ูุณูุช `let msg = ...` ุฑุง ูุฑุงุด ฺฉูุฏ.

### ุงูุฒูุฏู ุงุทูุงุนุงุช ุจุดุชุฑ

API ุงุทูุงุนุงุช ุฒุงุฏ ุจุฑูโฺฏุฑุฏุงูุฏ:
- `past24HourChanges`: ุชุบุฑุงุช 24 ุณุงุนุช
- `pollutionSourcePercentage`: ุฏุฑุตุฏ ููุงุจุน ุขููุฏฺฏ
- `todayWeather`: ุงุทูุงุนุงุช ุขุจ ู ููุง

ูโุชูุงูุฏ ุงูโูุง ุฑุง ุฏุฑ ฺฉุฏ Function ุงุถุงูู ฺฉูุฏ.

### ุชุบุฑ ุฒูุงู ุงุฌุฑุง

ุฏุฑ node "Every Hour":
- ูุฑ 30 ุฏููู: `Minutes interval = 30`
- ูุฑ 2 ุณุงุนุช: `Hours interval = 2`
- ุฑูุฒุงูู: `Hours interval = 24`

## ๐ ุชูุงูุช ุจุง Workflow AQMS (ุฎุฑุงุณุงู ุฑุถู)

| ูฺฺฏ | Mashhad Payesh | AQMS Khorasan |
|-------|---------------|---------------|
| ููุจุน ุฏุงุฏู | payesh.mashhad.ir | aqms.doe.ir |
| ูพูุดุด | ููุท ูุดูุฏ | ุงุณุชุงู ุฎุฑุงุณุงู ุฑุถู |
| ุงุญุฑุงุฒ ููุช | ุจุฏูู ูุงุฒ | ูุงุฒ ุจู Bearer Token |
| ุชุนุฏุงุฏ Request | 1 | 2 (Stations + AQI) |
| ุณุงุฎุชุงุฑ ุฏุงุฏู | Dashboard API | ุฏู API ุฌุฏุงฺฏุงูู |

## ๐ ุฐุฎุฑู ุฏุงุฏูโูุง ุชุงุฑุฎ

ุจุฑุง ุฐุฎุฑู:

1. ฺฉ node "Google Sheets" ุง "Database" ุงุถุงูู ฺฉูุฏ
2. ุจุนุฏ ุงุฒ "Build Telegram Message" ูุตู ฺฉูุฏ
3. ููุฏูุง `cityAqi`, `measuredAt` ู `top5` ุฑุง ุฐุฎุฑู ฺฉูุฏ

## ๐ ุงุฏุฏุงุดุชโูุง

- **API ุนููู**: ุงู API ุจุฏูู ูุงุฒ ุจู authentication ูุงุจู ุฏุณุชุฑุณ ุงุณุช
- **Rate Limiting**: ุจุง ุงุฌุฑุง ูุฑ ุณุงุนุช ูุดฺฉู ุงุฌุงุฏ ููโุดูุฏ
- **Timezone**: ุฒูุงู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจู ูุงุฑุณ ุชุจุฏู ูโุดูุฏ
- **Duplicate Prevention**: ุงุฒ ุงุฑุณุงู ูุฌุฏุฏ ููุงู ุฏุงุฏู ุฌููฺฏุฑ ูโฺฉูุฏ

## ๐ ุงููุช

- โ API ุนููู ุงุณุช ู ูุงุฒ ุจู ุชูฺฉู ูุฏุงุฑุฏ
- โ ุงุฒ Environment Variables ุจุฑุง TELEGRAM_CHAT_ID ุงุณุชูุงุฏู ฺฉูุฏ
- โ ุฏุณุชุฑุณ ุจู workflow ุฑุง ูุญุฏูุฏ ฺฉูุฏ

## ๐ ุงุทูุงุนุงุช API

**Endpoint**: `https://payesh.mashhad.ir/api/Dashboard/Citizen`

**ููููู Response**:
```json
{
  "data": {
    "aqi": 120,
    "instantAqi": 120,
    "airQualityMeasurementDateTime": "2025-10-30T09:00:00",
    "stationsAQI": [
      {
        "label": "ุงุณุชฺฏุงู ฺูู",
        "value": {
          "stationId": 1,
          "aqi": 145,
          "influetialParameter": "PM2.5",
          "dateTime": "2025-10-30T09:00:00"
        }
      }
    ],
    "past24HourChanges": {
      "cityAQI_Changes": [100, 105, 110, ...]
    }
  }
}
```

## ๐ ูพุดุชุจุงู

ุงฺฏุฑ ูุดฺฉู ุฏุงุดุชุฏ:
1. ูุงฺฏโูุง execution ุฑุง ุจุฑุฑุณ ฺฉูุฏ
2. ุฎุฑูุฌ HTTP Request ุฑุง ฺฺฉ ฺฉูุฏ
3. ุงุฒ "Execute Node" ุจุฑุง ุชุณุช ุงุณุชูุงุฏู ฺฉูุฏ

---

**ูุณุฎู**: 1.0
**ุชุงุฑุฎ**: ฑดฐด/ฐท/ณฐ
**ุณุงุฒูุฏู**: Claude Code
**ููุจุน ุฏุงุฏู**: [ูพุงุด ุดูุฑ ูุดูุฏ](https://payesh.mashhad.ir)
