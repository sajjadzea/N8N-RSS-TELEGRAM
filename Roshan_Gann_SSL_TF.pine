//@version=5
indicator("Roshan Gann SSL", shorttitle="Gann SSL", overlay=true)

// ════════════════════════════════════════════════════════════════════════════
// INPUT SETTINGS
// ════════════════════════════════════════════════════════════════════════════

// SSL Period
sslPeriod = input.int(10, "SSL Period", minval=1, tooltip="Period for SSL Channel calculation")

// Timeframe Settings
tfShift = input.int(0, "Timeframe Shift", minval=0, maxval=10,
     tooltip="0=Current TF, 1=Next TF (1min→5min), 2=Two steps up (1min→15min), etc.")

// MA Type Selection
maType = input.string("SMA", "MA Type", options=["SMA", "EMA", "WMA", "HMA"],
     tooltip="Type of moving average for SSL calculation")

// Visual Settings
showArrows = input.bool(true, "Show Buy/Sell Arrows", group="Visual Settings")
showLabels = input.bool(false, "Show Buy/Sell Labels", group="Visual Settings")
lineWidth = input.int(2, "Line Width", minval=1, maxval=5, group="Visual Settings")

// Color Settings
bullColor = input.color(color.new(#00ff00, 0), "Buy Color (Bull)", group="Colors")
bearColor = input.color(color.new(#ff0000, 0), "Sell Color (Bear)", group="Colors")

// ════════════════════════════════════════════════════════════════════════════
// TIMEFRAME CALCULATION
// ════════════════════════════════════════════════════════════════════════════

getTargetTimeframe(shift) =>
    currentTF = timeframe.in_seconds()

    // Timeframe ladder in seconds
    tfSeconds = array.from(60, 300, 900, 1800, 3600, 14400, 86400, 604800, 2592000)

    // Find current position in ladder
    currentIndex = 0
    for i = 0 to array.size(tfSeconds) - 1
        if currentTF <= array.get(tfSeconds, i)
            currentIndex := i
            break

    // Calculate target index
    targetIndex = math.min(currentIndex + shift, array.size(tfSeconds) - 1)
    targetSeconds = array.get(tfSeconds, targetIndex)

    // Convert seconds to timeframe string
    targetTF =
         targetSeconds == 60 ? "1" :
         targetSeconds == 300 ? "5" :
         targetSeconds == 900 ? "15" :
         targetSeconds == 1800 ? "30" :
         targetSeconds == 3600 ? "60" :
         targetSeconds == 14400 ? "240" :
         targetSeconds == 86400 ? "D" :
         targetSeconds == 604800 ? "W" : "M"

    targetTF

// Get target timeframe
targetTF = tfShift == 0 ? timeframe.period : getTargetTimeframe(tfShift)

// ════════════════════════════════════════════════════════════════════════════
// SSL GANN CALCULATION
// ════════════════════════════════════════════════════════════════════════════

// Function to calculate SSL values
calculateSSL(period, maTypeStr) =>
    // Calculate MA based on type
    maHigh = maTypeStr == "SMA" ? ta.sma(high, period) :
             maTypeStr == "EMA" ? ta.ema(high, period) :
             maTypeStr == "WMA" ? ta.wma(high, period) :
             maTypeStr == "HMA" ? ta.hma(high, period) :
             ta.sma(high, period)

    maLow = maTypeStr == "SMA" ? ta.sma(low, period) :
            maTypeStr == "EMA" ? ta.ema(low, period) :
            maTypeStr == "WMA" ? ta.wma(low, period) :
            maTypeStr == "HMA" ? ta.hma(low, period) :
            ta.sma(low, period)

    // Gann Hi-Lo Activator Logic
    var int trend = 0

    if close > maHigh
        trend := 1
    else if close < maLow
        trend := -1

    // SSL Channel Lines - Step-wise
    sslDown = trend < 0 ? maHigh : maLow
    sslUp = trend < 0 ? maLow : maHigh

    [sslDown, sslUp, trend]

// Request data from target timeframe
[sslDown, sslUp, trend] = request.security(syminfo.tickerid, targetTF,
     calculateSSL(sslPeriod, maType))

// ════════════════════════════════════════════════════════════════════════════
// SIGNAL DETECTION
// ════════════════════════════════════════════════════════════════════════════

// Detect trend changes
isBullish = trend > 0
isBearish = trend < 0
trendChanged = trend != trend[1]

// Buy and Sell signals
buySignal = trendChanged and isBullish
sellSignal = trendChanged and isBearish

// ════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ════════════════════════════════════════════════════════════════════════════

// Plot SSL Lines as STEPLINE (پله‌ای)
plot(isBullish ? sslUp : na, "SSL Buy Line", color=bullColor,
     linewidth=lineWidth, style=plot.style_stepline)
plot(isBullish ? sslDown : na, "SSL Buy Support", color=bullColor,
     linewidth=1, style=plot.style_stepline)

plot(isBearish ? sslDown : na, "SSL Sell Line", color=bearColor,
     linewidth=lineWidth, style=plot.style_stepline)
plot(isBearish ? sslUp : na, "SSL Sell Resistance", color=bearColor,
     linewidth=1, style=plot.style_stepline)

// Plot Entry Arrows (optional)
if showArrows
    plotshape(buySignal, "Buy Arrow", shape.triangleup, location.belowbar,
         color=bullColor, size=size.small, text="BUY")
    plotshape(sellSignal, "Sell Arrow", shape.triangledown, location.abovebar,
         color=bearColor, size=size.small, text="SELL")

// Plot Labels (optional)
if showLabels and buySignal
    label.new(bar_index, low, "BUY", style=label.style_label_up,
         color=bullColor, textcolor=color.white, size=size.normal)

if showLabels and sellSignal
    label.new(bar_index, high, "SELL", style=label.style_label_down,
         color=bearColor, textcolor=color.white, size=size.normal)

// ════════════════════════════════════════════════════════════════════════════
// ALERTS
// ════════════════════════════════════════════════════════════════════════════

alertcondition(buySignal, title="Gann SSL Buy Signal",
     message="Gann SSL: BUY Signal on {{ticker}} at {{close}}")

alertcondition(sellSignal, title="Gann SSL Sell Signal",
     message="Gann SSL: SELL Signal on {{ticker}} at {{close}}")

alertcondition(trendChanged, title="Gann SSL Trend Change",
     message="Gann SSL: Trend Changed on {{ticker}}")

// ════════════════════════════════════════════════════════════════════════════
// INFO TABLE
// ════════════════════════════════════════════════════════════════════════════

showTable = input.bool(true, "Show Info Panel", group="Visual Settings")

if showTable and barstate.islast
    var table infoTable = table.new(position.top_right, 2, 4,
         border_width=1, border_color=color.gray, frame_color=color.gray, frame_width=1)

    // Header
    table.cell(infoTable, 0, 0, "Roshan Gann SSL", bgcolor=color.new(color.gray, 70),
         text_color=color.white, text_size=size.normal)
    table.merge_cells(infoTable, 0, 0, 1, 0)

    // Period
    table.cell(infoTable, 0, 1, "Period:", text_halign=text.align_left,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(sslPeriod), text_halign=text.align_right,
         bgcolor=color.new(color.gray, 90), text_size=size.small)

    // Timeframe
    table.cell(infoTable, 0, 2, "Timeframe:", text_halign=text.align_left,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 2, targetTF, text_halign=text.align_right,
         bgcolor=color.new(color.gray, 90), text_size=size.small)

    // Trend
    trendText = isBullish ? "BUY ▲" : isBearish ? "SELL ▼" : "NEUTRAL"
    trendColor = isBullish ? bullColor : isBearish ? bearColor : color.gray

    table.cell(infoTable, 0, 3, "Signal:", text_halign=text.align_left,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 3, trendText, text_halign=text.align_right,
         text_color=trendColor, bgcolor=color.new(color.gray, 90),
         text_size=size.small)
