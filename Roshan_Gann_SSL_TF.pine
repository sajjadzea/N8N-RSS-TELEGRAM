//@version=5
indicator("Roshan Gann SSL TF", shorttitle="Gann SSL", overlay=true)

// ════════════════════════════════════════════════════════════════════════════
// INPUT SETTINGS
// ════════════════════════════════════════════════════════════════════════════

// SSL Channel Period
sslPeriod = input.int(10, "SSL Period", minval=1, tooltip="Period for SSL Channel MA calculation")

// Timeframe Settings
tfShift = input.int(0, "Timeframe Shift", minval=0, maxval=10, tooltip="0=Current TF, 1=Next TF (1min→5min), 2=Two steps up (1min→15min), etc.")

// MA Type Selection
maType = input.string("SMA", "MA Type", options=["SMA", "EMA", "WMA", "HMA"])

// Visual Settings
showArrows = input.bool(true, "Show Entry Signals", group="Visual")
showLabels = input.bool(true, "Show Trend Labels", group="Visual")
lineWidth = input.int(2, "Line Width", minval=1, maxval=5, group="Visual")

// Color Settings
bullColor = input.color(color.new(color.green, 0), "Bull Color", group="Colors")
bearColor = input.color(color.new(color.red, 0), "Bear Color", group="Colors")
bullColorFill = input.color(color.new(color.green, 85), "Bull Fill", group="Colors")
bearColorFill = input.color(color.new(color.red, 85), "Bear Fill", group="Colors")

// ════════════════════════════════════════════════════════════════════════════
// TIMEFRAME CALCULATION
// ════════════════════════════════════════════════════════════════════════════

// Function to calculate target timeframe based on shift
getTargetTimeframe(shift) =>
    currentTF = timeframe.in_seconds()

    // Timeframe ladder in seconds
    tfSeconds = array.new_int()
    array.push(tfSeconds, 60)        // 1 minute
    array.push(tfSeconds, 300)       // 5 minutes
    array.push(tfSeconds, 900)       // 15 minutes
    array.push(tfSeconds, 1800)      // 30 minutes
    array.push(tfSeconds, 3600)      // 1 hour
    array.push(tfSeconds, 14400)     // 4 hours
    array.push(tfSeconds, 86400)     // 1 day
    array.push(tfSeconds, 604800)    // 1 week
    array.push(tfSeconds, 2592000)   // 1 month

    // Find current position in ladder
    currentIndex = 0
    for i = 0 to array.size(tfSeconds) - 1
        if currentTF <= array.get(tfSeconds, i)
            currentIndex := i
            break

    // Calculate target index
    targetIndex = math.min(currentIndex + shift, array.size(tfSeconds) - 1)
    targetSeconds = array.get(tfSeconds, targetIndex)

    // Convert seconds to timeframe string
    targetTF =
         targetSeconds == 60 ? "1" :
         targetSeconds == 300 ? "5" :
         targetSeconds == 900 ? "15" :
         targetSeconds == 1800 ? "30" :
         targetSeconds == 3600 ? "60" :
         targetSeconds == 14400 ? "240" :
         targetSeconds == 86400 ? "D" :
         targetSeconds == 604800 ? "W" :
         "M"

    targetTF

// Get target timeframe
targetTF = tfShift == 0 ? timeframe.period : getTargetTimeframe(tfShift)

// ════════════════════════════════════════════════════════════════════════════
// MOVING AVERAGE FUNCTION
// ════════════════════════════════════════════════════════════════════════════

getMA(source, length, type) =>
    switch type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "WMA" => ta.wma(source, length)
        "HMA" => ta.hma(source, length)
        => ta.sma(source, length)

// ════════════════════════════════════════════════════════════════════════════
// SSL CHANNEL CALCULATION
// ════════════════════════════════════════════════════════════════════════════

// Calculate SSL on specified timeframe
[sslDown, sslUp, hlv] = request.security(syminfo.tickerid, targetTF, {
    // Calculate MA of High and Low
    maHigh = getMA(high, sslPeriod, maType)
    maLow = getMA(low, sslPeriod, maType)

    // Gann Hi-Lo Activator Logic
    var float hlv = na

    if close > maHigh
        hlv := 1
    else if close < maLow
        hlv := -1

    // SSL Channel Lines
    sslDown = hlv < 0 ? maHigh : maLow
    sslUp = hlv < 0 ? maLow : maHigh

    [sslDown, sslUp, hlv]
}, lookahead=barmerge.lookahead_off)

// ════════════════════════════════════════════════════════════════════════════
// TREND DETECTION
// ════════════════════════════════════════════════════════════════════════════

// Detect trend changes
isBullish = hlv == 1
isBearish = hlv == -1
trendChanged = hlv != hlv[1]

// Detect specific signals
bullSignal = trendChanged and isBullish
bearSignal = trendChanged and isBearish

// ════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ════════════════════════════════════════════════════════════════════════════

// Plot SSL Lines
plot(isBullish ? sslUp : na, "SSL Up", color=bullColor, linewidth=lineWidth, style=plot.style_line)
plot(isBearish ? sslDown : na, "SSL Down", color=bearColor, linewidth=lineWidth, style=plot.style_line)
plot(isBullish ? sslDown : na, "SSL Down (Bull)", color=bullColor, linewidth=1, style=plot.style_line)
plot(isBearish ? sslUp : na, "SSL Up (Bear)", color=bearColor, linewidth=1, style=plot.style_line)

// Fill between lines
upPlot = plot(sslUp, color=na, display=display.none)
downPlot = plot(sslDown, color=na, display=display.none)
fill(upPlot, downPlot, color=isBullish ? bullColorFill : bearColorFill, title="SSL Fill")

// Plot Entry Signals
if showArrows
    plotshape(bullSignal, "Buy Signal", shape.triangleup, location.belowbar,
         color=bullColor, size=size.small)
    plotshape(bearSignal, "Sell Signal", shape.triangledown, location.abovebar,
         color=bearColor, size=size.small)

// Show Labels
if showLabels
    if bullSignal
        label.new(bar_index, low, "BUY", style=label.style_label_up,
             color=bullColor, textcolor=color.white, size=size.small)
    if bearSignal
        label.new(bar_index, high, "SELL", style=label.style_label_down,
             color=bearColor, textcolor=color.white, size=size.small)

// ════════════════════════════════════════════════════════════════════════════
// ALERTS
// ════════════════════════════════════════════════════════════════════════════

// Alert Conditions
alertcondition(bullSignal, title="Gann SSL Buy",
     message="Gann SSL: Buy Signal on {{ticker}} at {{close}}")
alertcondition(bearSignal, title="Gann SSL Sell",
     message="Gann SSL: Sell Signal on {{ticker}} at {{close}}")
alertcondition(trendChanged, title="Gann SSL Trend Change",
     message="Gann SSL: Trend Changed on {{ticker}}")

// ════════════════════════════════════════════════════════════════════════════
// BACKGROUND COLOR (Optional)
// ════════════════════════════════════════════════════════════════════════════

showBG = input.bool(false, "Show Background Color", group="Visual")
bgcolor(showBG and isBullish ? color.new(bullColor, 95) :
     showBG and isBearish ? color.new(bearColor, 95) : na)

// ════════════════════════════════════════════════════════════════════════════
// INFO TABLE (Display current timeframe and settings)
// ════════════════════════════════════════════════════════════════════════════

showTable = input.bool(true, "Show Info Table", group="Visual")

if showTable and barstate.islast
    var table infoTable = table.new(position.top_right, 2, 4,
         border_width=1, border_color=color.gray, frame_color=color.gray, frame_width=1)

    table.cell(infoTable, 0, 0, "Gann SSL Settings", bgcolor=color.new(color.gray, 70),
         text_color=color.white, text_size=size.small)
    table.merge_cells(infoTable, 0, 0, 1, 0)

    table.cell(infoTable, 0, 1, "Period:", text_halign=text.align_left,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(sslPeriod), text_halign=text.align_right,
         bgcolor=color.new(color.gray, 90), text_size=size.small)

    table.cell(infoTable, 0, 2, "Timeframe:", text_halign=text.align_left,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 2, targetTF, text_halign=text.align_right,
         bgcolor=color.new(color.gray, 90), text_size=size.small)

    table.cell(infoTable, 0, 3, "Trend:", text_halign=text.align_left,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 3, isBullish ? "BULL" : "BEAR",
         text_halign=text.align_right, text_color=isBullish ? bullColor : bearColor,
         bgcolor=color.new(color.gray, 90), text_size=size.small)
