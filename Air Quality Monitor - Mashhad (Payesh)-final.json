{
  "name": "Air Quality Monitor - Mashhad (Payesh)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "id": "6bc42820-51d7-4e30-b37e-69ee6dcd4475",
      "name": "Every Hour",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1104,
        112
      ]
    },
    {
      "parameters": {
        "url": "https://payesh.mashhad.ir/api/Dashboard/Citizen",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "User-Agent",
              "value": "n8n-payesh-fetcher/1.0"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "c0ad8acf-52e7-4741-8fd6-36963871ea47",
      "name": "Get Dashboard (Payesh)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -880,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build Telegram Markdown message from payesh.mashhad.ir API response\nconst data = $input.item.json.data || $input.item.json; // safe access\nconst faNums = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];\n\nfunction toFaDigits(s){\n  if (s === null || s === undefined) return '';\n  return String(s).replace(/\\d/g, d => faNums[Number(d)]);\n}\n\nfunction fmtTime(iso){\n  try{\n    const d = new Date(iso);\n    return d.toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year:'numeric', month:'2-digit', day:'2-digit' });\n  } catch(e){ return iso || ''; }\n}\n\n// ØªØ§Ø¨Ø¹ ØªØ´Ø®ÛŒØµ Ø³Ø·Ø­ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ùˆ Ø§ÛŒÙ…ÙˆØ¬ÛŒ\nfunction getAQIInfo(aqi) {\n  if (aqi <= 50) {\n    return {\n      emoji: 'ğŸ”µ',\n      level: 'Ø®ÙˆØ¨',\n      description: 'Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§ Ø±Ø¶Ø§ÛŒØªâ€ŒØ¨Ø®Ø´ Ø§Ø³Øª Ùˆ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ Ú©Ù… ÛŒØ§ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø± Ø§Ø³Øª.'\n    };\n  } else if (aqi <= 100) {\n    return {\n      emoji: 'ğŸŸ¢',\n      level: 'Ù‚Ø§Ø¨Ù„â€ŒÙ‚Ø¨ÙˆÙ„',\n      description: 'Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø®ÛŒ Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø¬Ø²Ø¦ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.'\n    };\n  } else if (aqi <= 150) {\n    return {\n      emoji: 'ğŸŸ¡',\n      level: 'Ù†Ø§Ø³Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³',\n      description: 'Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªØ­Øª ØªØ£Ø«ÛŒØ± Ù‚Ø±Ø§Ø± Ú¯ÛŒØ±Ù†Ø¯. Ø¹Ù…ÙˆÙ… Ù…Ø±Ø¯Ù… Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ ØªØ­Øª ØªØ£Ø«ÛŒØ± Ù‚Ø±Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯.'\n    };\n  } else if (aqi <= 200) {\n    return {\n      emoji: 'ğŸ”´',\n      level: 'Ù†Ø§Ø³Ø§Ù„Ù…',\n      description: 'Ù‡Ù…Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø§Ø­Ø³Ø§Ø³ Ø§Ø«Ø±Ø§Øª Ø¨Ø± Ø³Ù„Ø§Ù…ØªÛŒ Ú©Ù†Ù†Ø¯. Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ø«Ø±Ø§Øª Ø¬Ø¯ÛŒâ€ŒØªØ±ÛŒ Ø±Ø§ ØªØ¬Ø±Ø¨Ù‡ Ú©Ù†Ù†Ø¯.'\n    };\n  } else if (aqi <= 300) {\n    return {\n      emoji: 'ğŸŸ£',\n      level: 'Ø¨Ø³ÛŒØ§Ø± Ù†Ø§Ø³Ø§Ù„Ù…',\n      description: 'Ù‡Ø´Ø¯Ø§Ø± Ø³Ù„Ø§Ù…Øª: Ù‡Ù…Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ø«Ø±Ø§Øª Ø¬Ø¯ÛŒâ€ŒØªØ±ÛŒ Ø¨Ø± Ø³Ù„Ø§Ù…ØªÛŒ Ø±Ø§ ØªØ¬Ø±Ø¨Ù‡ Ú©Ù†Ù†Ø¯.'\n    };\n  } else {\n    return {\n      emoji: 'âš«',\n      level: 'Ø®Ø·Ø±Ù†Ø§Ú©',\n      description: 'Ù‡Ø´Ø¯Ø§Ø± Ø³Ù„Ø§Ù…Øª Ø¯Ø± Ø³Ø·Ø­ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Ú©Ù„ Ø¬Ù…Ø¹ÛŒØª Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù…Ø¹Ø±Ø¶ ØªØ£Ø«ÛŒØ± Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯.'\n    };\n  }\n}\n\n// ØªØ§Ø¨Ø¹ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø±ÙØªØ§Ø±ÛŒ\nfunction getAdvice(aqi) {\n  if (aqi <= 50) {\n    return 'ğŸŒ¿ Ù‡ÙˆØ§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ Ø¨ÛŒØ´ØªØ± Ø§ÙØ±Ø§Ø¯ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ù„Ø°Øª Ø¨Ø¨Ø±ÛŒØ¯.';\n  } else if (aqi <= 100) {\n    return 'âœ… Ø§ÙØ±Ø§Ø¯ Ø¨Ø³ÛŒØ§Ø± Ø­Ø³Ø§Ø³ Ø¨Ø§ÛŒØ¯ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†Ù†Ø¯.';\n  } else if (aqi <= 150) {\n    return 'âš ï¸ Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ØŒ Ú©ÙˆØ¯Ú©Ø§Ù† Ùˆ Ø³Ø§Ù„Ù…Ù†Ø¯Ø§Ù† Ø¨Ø§ÛŒØ¯ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡Ù†Ø¯.';\n  } else if (aqi <= 200) {\n    return 'ğŸš« ÙØ¹Ø§Ù„ÛŒØª ÙˆØ±Ø²Ø´ÛŒ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² ØªÙˆØµÛŒÙ‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§Ú¯Ø± Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ±ÙˆÛŒØ¯ØŒ Ø§Ø² Ù…Ø§Ø³Ú© Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.';\n  } else if (aqi <= 300) {\n    return 'â›” Ø§Ø² ÙØ¹Ø§Ù„ÛŒØª Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯. Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ø¯Ø± Ø®Ø§Ù†Ù‡ Ø¨Ù…Ø§Ù†Ù†Ø¯ Ùˆ Ø§Ø² Ù…Ø§Ø³Ú© N95 Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù†Ø¯.';\n  } else {\n    return 'ğŸ†˜ ÙˆØ¶Ø¹ÛŒØª Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ! Ù‡Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø³ØªÙ‡ Ø¨Ù…Ø§Ù†Ù†Ø¯ Ùˆ Ø§Ø² ØªØµÙÛŒÙ‡â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ù‡ÙˆØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù†Ø¯.';\n  }\n}\n\n// -------------- summary top (worst) stations --------------\nconst stations = data.stationsAQI || [];\nconst mapped = stations.map(s => {\n  const v = s.value || {};\n  return {\n    name: s.label || '',\n    aqi: Number(v.aqi || 0),\n    param: v.influetialParameter || '',\n    time: v.dateTime || ''\n  };\n});\n\n// sort desc by aqi\nmapped.sort((a,b)=>b.aqi - a.aqi);\nconst top5 = mapped.slice(0,5);\n\n// overall city aqi from root\nconst cityAqi = Number(data.aqi ?? data.instantAqi ?? 0);\nconst cityAqiFa = toFaDigits(cityAqi);\nconst aqiInfo = getAQIInfo(cityAqi);\nconst advice = getAdvice(cityAqi);\n\n// time\nconst measurementTime = data.airQualityMeasurementDateTime || (top5[0] && top5[0].time) || '';\nconst measurementTimeFmt = measurementTime ? fmtTime(measurementTime) : 'â€”';\n\n// Build markdown message\nlet msg = `*Ø´Ø§Ø®Øµ Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§ â€” Ù…Ø´Ù‡Ø¯*\\n\\n`;\nmsg += `ğŸ• Ø²Ù…Ø§Ù† Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ: ${measurementTimeFmt}\\n\\n`;\n\n// Ø´Ø§Ø®Øµ Ú©Ù„ Ø´Ù‡Ø± Ø¨Ø§ Ø§ÛŒÙ…ÙˆØ¬ÛŒ\nmsg += `ğŸ“Š *Ø´Ø§Ø®Øµ Ú©Ù„ Ø´Ù‡Ø±: ${cityAqiFa} ${aqiInfo.emoji}*\\n`;\nmsg += `Ø³Ø·Ø­: *${aqiInfo.level}*\\n\\n`;\n\n// ØªÙˆØ¶ÛŒØ­ ÙˆØ¶Ø¹ÛŒØª\nmsg += `ğŸ’¬ ${aqiInfo.description}\\n\\n`;\n\n// Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø±ÙØªØ§Ø±ÛŒ\nmsg += `${advice}\\n\\n`;\n\n// Ù¾Ù†Ø¬ Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ø¨Ø¯ØªØ±ÛŒÙ† ÙˆØ¶Ø¹ÛŒØª\nmsg += `*ğŸ“ Ù¾Ù†Ø¬ Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ø¨Ø¯ØªØ±ÛŒÙ† ÙˆØ¶Ø¹ÛŒØª:*\\n`;\n\ntop5.forEach((s,i)=>{\n  const stationInfo = getAQIInfo(s.aqi);\n  msg += `${i+1}. *${s.name}* â€” ${toFaDigits(s.aqi)} ${stationInfo.emoji}`;\n  if(s.param) msg += ` â€” Ø¢Ù„Ø§ÛŒÙ†Ø¯Ù‡: ${s.param}`;\n  msg += `\\n`;\n});\n\nmsg += `\\n_ğŸ¤– Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Ú©Ø§Ø± â€” Ù‡Ø± Ø³Ø§Ø¹Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯_`;\n\nreturn [{ json: { send: true, message: msg, meta: { cityAqi: cityAqi, measuredAt: measurementTime } } }];"
      },
      "id": "db307a24-6343-405d-9cb8-99c53ef2e473",
      "name": "Build Telegram Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Add trend information by comparing with previous AQI\nconst input = $input.item.json;\nconst currentAqi = input.meta.cityAqi;\nconst currentMessage = input.message;\n\n// Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Workflow Static Data\nconst workflowStaticData = this.getWorkflowStaticData('global');\nconst previousAqi = workflowStaticData.lastAqi || null;\n\n// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆÙ†Ø¯\nlet trendInfo = '';\nif (previousAqi !== null && previousAqi !== undefined) {\n  const diff = currentAqi - previousAqi;\n  const diffAbs = Math.abs(diff);\n  const faNums = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];\n  const toFaDigits = (s) => String(s).replace(/\\d/g, d => faNums[Number(d)]);\n  \n  if (diff > 0) {\n    // Ø¨Ø¯ØªØ± Ø´Ø¯Ù‡\n    trendInfo = `ğŸ”º Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø³Ø§Ø¹Øª Ù‚Ø¨Ù„: Ø§ÙØ²Ø§ÛŒØ´ ${toFaDigits(diffAbs)} ÙˆØ§Ø­Ø¯ÛŒ`;\n  } else if (diff < 0) {\n    // Ø¨Ù‡ØªØ± Ø´Ø¯Ù‡\n    trendInfo = `ğŸ”» Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø³Ø§Ø¹Øª Ù‚Ø¨Ù„: Ø¨Ù‡Ø¨ÙˆØ¯ ${toFaDigits(diffAbs)} ÙˆØ§Ø­Ø¯ÛŒ`;\n  } else {\n    // ØªØºÛŒÛŒØ±ÛŒ Ù†Ú©Ø±Ø¯Ù‡\n    trendInfo = `â¡ï¸ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø³Ø§Ø¹Øª Ù‚Ø¨Ù„: Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±`;\n  }\n}\n\n// Ø°Ø®ÛŒØ±Ù‡ AQI ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯ÙØ¹Ù‡ Ø¨Ø¹Ø¯\nworkflowStaticData.lastAqi = currentAqi;\n\n// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆÙ†Ø¯ Ø¨Ù‡ Ù¾ÛŒØ§Ù… (Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø· \"Ø³Ø·Ø­:\")\nlet updatedMessage = currentMessage;\nif (trendInfo) {\n  const lines = currentMessage.split('\\n');\n  const updatedLines = [];\n  \n  for (let i = 0; i < lines.length; i++) {\n    updatedLines.push(lines[i]);\n    // Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø· \"Ø³Ø·Ø­:\" Ø±ÙˆÙ†Ø¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†\n    if (lines[i].includes('Ø³Ø·Ø­:')) {\n      updatedLines.push(trendInfo);\n    }\n  }\n  \n  updatedMessage = updatedLines.join('\\n');\n}\n\nreturn [{ json: { send: input.send, message: updatedMessage, meta: input.meta } }];"
      },
      "id": "a7f3e8b9-1234-5678-9abc-def012345678",
      "name": "Add Trend Info",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -552,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = items[0].json;\nconst lastSent = $json[\"last_sent_measuredAt\"];  // Ø§Ø² Workflow Data node Ù‚Ø¨Ù„ÛŒ\nconst measuredAt = input.meta?.measuredAt || new Date().toISOString();\n\nif (lastSent === measuredAt) {\n  return [{ json: { send: false } }];\n}\n\n// Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Workflow Data\nreturn [\n  { json: { send: true, message: input.message, last_sent_measuredAt: measuredAt } }\n];\n"
      },
      "id": "c2ea4a38-74cd-420d-9cd1-933715bde05d",
      "name": "Deduplicate / Send Control",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.send }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "9e751a18-afc8-4ffe-beb6-1ec1ffb8ae9d",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -224,
        112
      ]
    },
    {
      "parameters": {
        "chatId": "-1003207884746",
        "text": "={{$json[\"message\"]}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        16,
        112
      ],
      "id": "18cea6f8-1d82-417d-bf60-726ffd884e89",
      "name": "payeshhavaymashhad",
      "webhookId": "8669ec39-5336-4fba-8d44-e08422deb0dd",
      "credentials": {
        "telegramApi": {
          "id": "XQQsqYp1ELPoAiPW",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Every Hour": {
      "main": [
        [
          {
            "node": "Get Dashboard (Payesh)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Dashboard (Payesh)": {
      "main": [
        [
          {
            "node": "Build Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Telegram Message": {
      "main": [
        [
          {
            "node": "Add Trend Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Trend Info": {
      "main": [
        [
          {
            "node": "Deduplicate / Send Control",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplicate / Send Control": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "payeshhavaymashhad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "28ca7331-d946-4d6f-b4a7-ce57370b9094",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "4e0628fc4b63415fcf4675b9a65d35e9aec0859861006249ad779582a713f03d"
  },
  "id": "LgECL8ZwULpglRKY",
  "tags": []
}