{
  "name": "Research Priorities - Tavanir Khorasan",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "schedule-trigger-tavanir",
      "name": "Every 12 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1300,
        400
      ]
    },
    {
      "parameters": {
        "url": "https://satab.tavanir.org.ir/Account/TBL_Place_Login_Page_APIDdl",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "application/json, text/plain, */*"
            },
            {
              "name": "Accept-Language",
              "value": "fa-IR,fa;q=0.9,en-US;q=0.8,en;q=0.7"
            },
            {
              "name": "Referer",
              "value": "https://satab.tavanir.org.ir/"
            },
            {
              "name": "Origin",
              "value": "https://satab.tavanir.org.ir"
            }
          ]
        },
        "options": {}
      },
      "id": "http-get-companies",
      "name": "Fetch Companies List",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1080,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø³Ù‡ Ø´Ø±Ú©Øª Ø®Ø±Ø§Ø³Ø§Ù†ÛŒ\nconst data = $input.item.json;\n\n// Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ data Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª ÛŒØ§ Ù†Ù‡\nconst companies = Array.isArray(data) ? data : (data.data || []);\n\nif (companies.length === 0) {\n  console.log('No companies received from API');\n  return [{\n    json: {\n      error: 'No companies data',\n      companies: []\n    }\n  }];\n}\n\n// Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±\nconst targetCompanies = [\n  'ØªÙˆØ²ÛŒØ¹ Ø¨Ø±Ù‚ Ù…Ø´Ù‡Ø¯',\n  'ØªÙˆØ²ÛŒØ¹ Ù†ÛŒØ±ÙˆÛŒ Ø¨Ø±Ù‚ Ù…Ø´Ù‡Ø¯',\n  'Ø´Ø±Ú©Øª ØªÙˆØ²ÛŒØ¹ Ø¨Ø±Ù‚ Ù…Ø´Ù‡Ø¯',\n  'Ø´Ø±Ú©Øª ØªÙˆØ²ÛŒØ¹ Ù†ÛŒØ±ÙˆÛŒ Ø¨Ø±Ù‚ Ù…Ø´Ù‡Ø¯',\n  'ØªÙˆØ²ÛŒØ¹ Ø¨Ø±Ù‚ Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ',\n  'ØªÙˆØ²ÛŒØ¹ Ù†ÛŒØ±ÙˆÛŒ Ø¨Ø±Ù‚ Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ',\n  'Ø´Ø±Ú©Øª ØªÙˆØ²ÛŒØ¹ Ø¨Ø±Ù‚ Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ',\n  'Ø´Ø±Ú©Øª ØªÙˆØ²ÛŒØ¹ Ù†ÛŒØ±ÙˆÛŒ Ø¨Ø±Ù‚ Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ',\n  'Ø¨Ø±Ù‚ Ù…Ù†Ø·Ù‚Ù‡ Ø§ÛŒ Ø®Ø±Ø§Ø³Ø§Ù†',\n  'Ø¨Ø±Ù‚ Ù…Ù†Ø·Ù‚Ù‡â€ŒØ§ÛŒ Ø®Ø±Ø§Ø³Ø§Ù†',\n  'Ø´Ø±Ú©Øª Ø¨Ø±Ù‚ Ù…Ù†Ø·Ù‚Ù‡ Ø§ÛŒ Ø®Ø±Ø§Ø³Ø§Ù†',\n  'Ø´Ø±Ú©Øª Ø¨Ø±Ù‚ Ù…Ù†Ø·Ù‚Ù‡â€ŒØ§ÛŒ Ø®Ø±Ø§Ø³Ø§Ù†'\n];\n\n// ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø±Ø§Ø³Ø§Ù†ÛŒ\nconst khorasanCompanies = companies.filter(company => {\n  const companyName = (company.TextMember || '').trim();\n  \n  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚\n  for (const target of targetCompanies) {\n    if (companyName === target) {\n      return true;\n    }\n  }\n  \n  // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù†Ø§Ù… Ø´Ø§Ù…Ù„ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø§Ø³Øª\n  const lowerName = companyName.toLowerCase();\n  const isMashhad = lowerName.includes('Ù…Ø´Ù‡Ø¯');\n  const isKhorasan = lowerName.includes('Ø®Ø±Ø§Ø³Ø§Ù†');\n  const isDistribution = lowerName.includes('ØªÙˆØ²ÛŒØ¹');\n  const isRegional = lowerName.includes('Ù…Ù†Ø·Ù‚Ù‡');\n  \n  return (isMashhad || isKhorasan) && (isDistribution || isRegional);\n});\n\nconsole.log(`Total companies: ${companies.length}`);\nconsole.log(`Khorasan companies found: ${khorasanCompanies.length}`);\n\n// Ø³Ø§Ø®Øª Ø¢Ø±Ø§ÛŒÙ‡ Ø®Ø±ÙˆØ¬ÛŒ - Ù‡Ø± Ø´Ø±Ú©Øª ÛŒÚ© Ø¢ÛŒØªÙ… Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\nconst output = khorasanCompanies.map(company => ({\n  json: {\n    companyId: company.ValueMember,\n    companyName: company.TextMember\n  }\n}));\n\nif (output.length === 0) {\n  // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø´Ø±Ú©ØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ÛŒÚ© Ø¢ÛŒØªÙ… Ø®Ø·Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ…\n  return [{\n    json: {\n      error: 'No Khorasan companies found',\n      allCompanies: companies.map(c => c.TextMember),\n      companyId: null,\n      companyName: null\n    }\n  }];\n}\n\nreturn output;"
      },
      "id": "code-filter-companies",
      "name": "Filter Khorasan Companies",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -860,
        400
      ]
    },
    {
      "parameters": {
        "url": "https://satab.tavanir.org.ir/Account/FillBDG_BUD_Project_Priority",
        "authentication": "none",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "application/json, text/plain, */*"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded; charset=UTF-8"
            },
            {
              "name": "Accept-Language",
              "value": "fa-IR,fa;q=0.9,en-US;q=0.8,en;q=0.7"
            },
            {
              "name": "Referer",
              "value": "https://satab.tavanir.org.ir/"
            },
            {
              "name": "Origin",
              "value": "https://satab.tavanir.org.ir"
            },
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "string",
        "body": "=sort=&page=1&pageSize=100&group=&filter=&TBL_PlaceID_fk={{ $json.companyId }}",
        "options": {}
      },
      "id": "http-get-projects",
      "name": "Fetch Projects for Company",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -640,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ØªØ±Ú©ÛŒØ¨ response API Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø±Ú©Øª\nconst apiResponse = $input.item.json;\nconst allItems = $input.all();\n\n// Ø¯Ø±ÛŒØ§ÙØª companyName Ùˆ companyId Ø§Ø² item Ø§ÙˆÙ„ (Ú©Ù‡ Ø§Ø² node Ù‚Ø¨Ù„ÛŒ Ø¢Ù…Ø¯Ù‡)\nconst firstItem = allItems[0];\nconst previousData = firstItem.json;\n\nreturn [{\n  json: {\n    apiResponse: apiResponse,\n    companyId: previousData.companyId || null,\n    companyName: previousData.companyName || 'Ù†Ø§Ù…Ø´Ø®Øµ'\n  }\n}];"
      },
      "id": "code-merge-company-info",
      "name": "Merge Company Info with Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -520,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§\nconst data = $input.item.json;\nconst response = data.apiResponse || data;\nconst companyName = data.companyName || 'Ù†Ø§Ù…Ø´Ø®Øµ';\n\n// ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ\nconst faNums = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];\nfunction toFaDigits(s) {\n  if (s === null || s === undefined) return '';\n  return String(s).replace(/\\d/g, d => faNums[Number(d)]);\n}\n\n// ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ (Ø³Ø§Ø¯Ù‡)\nfunction formatDate(dateStr) {\n  if (!dateStr) return '';\n  \n  // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¨Ù‡ ÙØ±Ù…Øª ISO ÛŒØ§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø§Ø³ØªØŒ Ù‡Ù…Ø§Ù† Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…\n  // Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù† ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯\n  try {\n    const date = new Date(dateStr);\n    if (isNaN(date.getTime())) {\n      return toFaDigits(dateStr);\n    }\n    return toFaDigits(dateStr);\n  } catch (e) {\n    return toFaDigits(dateStr);\n  }\n}\n\ntry {\n  // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø®\n  let projectsData = [];\n  \n  if (response.Data && Array.isArray(response.Data)) {\n    projectsData = response.Data;\n  } else if (Array.isArray(response)) {\n    projectsData = response;\n  } else {\n    console.log('Unexpected response structure');\n    return [{\n      json: {\n        error: 'Invalid response structure',\n        response: response,\n        projects: []\n      }\n    }];\n  }\n  \n  console.log(`Projects found: ${projectsData.length}`);\n  \n  // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù‡Ø± Ù¾Ø±ÙˆÚ˜Ù‡\n  const projects = projectsData.map(project => {\n    return {\n      title: project.BUD_ProjectBudgetTitle || '',\n      company: project.TBL_PlaceName || companyName,\n      mainAxis: project.PMS_PcName || '',\n      subAxis: project.PMS_PnName || '',\n      status: project.PMS_PsName || '',\n      finalProduct: project.BUD_PriorityFinalProduct || '',\n      publishDate: formatDate(project.BUD_ProjectTempDeliveryDate),\n      deadline: formatDate(project.BUD_PeiUsageRequiredDate),\n      // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ù†Ø¯\n      projectId: project.BUD_ProjectID || project.Id || '',\n      budget: project.BUD_ProjectBudget || '',\n      duration: project.BUD_ProjectDuration || ''\n    };\n  });\n  \n  return [{\n    json: {\n      success: true,\n      company: companyName,\n      projects: projects,\n      count: projects.length,\n      total: response.Total || projects.length\n    }\n  }];\n  \n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      error: error.message,\n      errorStack: error.stack,\n      projects: [],\n      rawResponse: response\n    }\n  }];\n}"
      },
      "id": "code-parse-projects",
      "name": "Parse Projects Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -420,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ØªØ±Ú©ÛŒØ¨ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ù… Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§\nconst items = $input.all();\n\nconst allProjects = [];\nconst companiesSummary = [];\n\nitems.forEach(item => {\n  const data = item.json;\n  \n  if (data.success && data.projects) {\n    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§\n    data.projects.forEach(project => {\n      allProjects.push(project);\n    });\n    \n    // Ø®Ù„Ø§ØµÙ‡ Ù‡Ø± Ø´Ø±Ú©Øª\n    companiesSummary.push({\n      company: data.company,\n      count: data.count,\n      total: data.total\n    });\n  }\n});\n\nconsole.log(`Total projects from all companies: ${allProjects.length}`);\n\nreturn [{\n  json: {\n    success: true,\n    allProjects: allProjects,\n    totalCount: allProjects.length,\n    companies: companiesSummary,\n    companiesCount: companiesSummary.length\n  }\n}];"
      },
      "id": "code-merge-projects",
      "name": "Merge All Projects",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ØªØ´Ø®ÛŒØµ ØªØºÛŒÛŒØ±Ø§Øª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ\nconst data = $input.item.json;\nconst currentProjects = data.allProjects || [];\n\nconst workflowStaticData = $getWorkflowStaticData('global');\nconst previousProjects = workflowStaticData.tavanirProjects || {};\n\nconst newProjects = [];\nconst updatedProjects = [];\nconst unchangedProjects = [];\n\n// Ø³Ø§Ø®Øª Map Ø§Ø² Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ\nconst currentProjectsMap = {};\ncurrentProjects.forEach(project => {\n  // Ú©Ù„ÛŒØ¯ ÛŒÙˆÙ†ÛŒÚ©: ØªØ±Ú©ÛŒØ¨ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø´Ø±Ú©Øª\n  const key = `${project.title.trim()}||${project.company.trim()}`;\n  currentProjectsMap[key] = project;\n});\n\n// Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± Ù¾Ø±ÙˆÚ˜Ù‡\ncurrentProjects.forEach(project => {\n  const key = `${project.title.trim()}||${project.company.trim()}`;\n  const prevProject = previousProjects[key];\n  \n  if (!prevProject) {\n    // Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª\n    newProjects.push({\n      ...project,\n      changeType: 'new'\n    });\n  } else {\n    // Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª\n    const changes = [];\n    \n    if (prevProject.status !== project.status) {\n      changes.push({\n        field: 'ÙˆØ¶Ø¹ÛŒØª',\n        oldValue: prevProject.status,\n        newValue: project.status\n      });\n    }\n    \n    if (prevProject.deadline !== project.deadline) {\n      changes.push({\n        field: 'Ù…Ù‡Ù„Øª Ù¾Ø°ÛŒØ±Ø´',\n        oldValue: prevProject.deadline,\n        newValue: project.deadline\n      });\n    }\n    \n    if (prevProject.publishDate !== project.publishDate) {\n      changes.push({\n        field: 'ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±',\n        oldValue: prevProject.publishDate,\n        newValue: project.publishDate\n      });\n    }\n    \n    if (prevProject.finalProduct !== project.finalProduct) {\n      changes.push({\n        field: 'Ù…Ø­ØµÙˆÙ„ Ù†Ù‡Ø§ÛŒÛŒ',\n        oldValue: prevProject.finalProduct,\n        newValue: project.finalProduct\n      });\n    }\n    \n    if (changes.length > 0) {\n      updatedProjects.push({\n        ...project,\n        changeType: 'updated',\n        changes: changes\n      });\n    } else {\n      unchangedProjects.push({\n        ...project,\n        changeType: 'unchanged'\n      });\n    }\n  }\n});\n\n// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡\nworkflowStaticData.tavanirProjects = currentProjectsMap;\nworkflowStaticData.lastCheckTime = new Date().toISOString();\n\nreturn [{\n  json: {\n    success: true,\n    newCount: newProjects.length,\n    updatedCount: updatedProjects.length,\n    unchangedCount: unchangedProjects.length,\n    totalCount: currentProjects.length,\n    newProjects: newProjects,\n    updatedProjects: updatedProjects,\n    unchangedProjects: unchangedProjects,\n    hasChanges: (newProjects.length > 0 || updatedProjects.length > 0),\n    companies: data.companies\n  }\n}];"
      },
      "id": "code-detect-changes",
      "name": "Detect Changes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡\nconst data = $input.item.json;\nconst newProjects = data.newProjects || [];\nconst updatedProjects = data.updatedProjects || [];\nconst companies = data.companies || [];\n\nif (!data.hasChanges) {\n  return [{\n    json: {\n      send: false,\n      message: 'âœ… *Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯*\\n\\nÙ‡ÛŒÚ† Ø§ÙˆÙ„ÙˆÛŒØª ØªØ­Ù‚ÛŒÙ‚Ø§ØªÛŒ Ø¬Ø¯ÛŒØ¯ ÛŒØ§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø± Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø±Ø§Ø³Ø§Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.',\n      messageType: 'no_changes'\n    }\n  }];\n}\n\nconst faNums = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];\nfunction toFaDigits(s) {\n  if (s === null || s === undefined) return '';\n  return String(s).replace(/\\d/g, d => faNums[Number(d)]);\n}\n\nconst messages = [];\n\n// Ù¾ÛŒØ§Ù… Ø®Ù„Ø§ØµÙ‡\nlet summaryMsg = `ğŸ”” *Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ ØªØ­Ù‚ÛŒÙ‚Ø§ØªÛŒ â€” ØµÙ†Ø¹Øª Ø¨Ø±Ù‚ Ø®Ø±Ø§Ø³Ø§Ù†*\\n\\n`;\n\nif (companies.length > 0) {\n  summaryMsg += `*ğŸ“Š Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡:*\\n`;\n  companies.forEach(comp => {\n    summaryMsg += `â–«ï¸ ${comp.company}: ${toFaDigits(comp.count)} Ù¾Ø±ÙˆÚ˜Ù‡\\n`;\n  });\n  summaryMsg += `\\n`;\n}\n\nif (newProjects.length > 0) {\n  summaryMsg += `ğŸ†• *Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯:* ${toFaDigits(newProjects.length)}\\n`;\n}\nif (updatedProjects.length > 0) {\n  summaryMsg += `ğŸ”„ *Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§:* ${toFaDigits(updatedProjects.length)}\\n`;\n}\n\nsummaryMsg += `\\nğŸ“… *Ø²Ù…Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ:* ${new Date().toLocaleString('fa-IR')}\\n\\n`;\nsummaryMsg += `_Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯._`;\n\nmessages.push({\n  json: {\n    send: true,\n    message: summaryMsg,\n    messageType: 'summary',\n    index: 0\n  }\n});\n\n// Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯\nnewProjects.forEach((project, index) => {\n  let msg = `ğŸ†• *Ø§ÙˆÙ„ÙˆÛŒØª ØªØ­Ù‚ÛŒÙ‚Ø§ØªÛŒ Ø¬Ø¯ÛŒØ¯*\\n\\n`;\n  \n  if (project.title) {\n    msg += `*ğŸ“Œ Ø¹Ù†ÙˆØ§Ù†:*\\n${project.title}\\n\\n`;\n  }\n  \n  if (project.company) {\n    msg += `*ğŸ¢ Ø´Ø±Ú©Øª:*\\n${project.company}\\n\\n`;\n  }\n  \n  if (project.mainAxis) {\n    msg += `*ğŸ¯ Ù…Ø­ÙˆØ± Ø§ØµÙ„ÛŒ:*\\n${project.mainAxis}\\n\\n`;\n  }\n  \n  if (project.subAxis) {\n    msg += `*ğŸ“ Ø²ÛŒØ± Ù…Ø­ÙˆØ±:*\\n${project.subAxis}\\n\\n`;\n  }\n  \n  if (project.finalProduct) {\n    msg += `*ğŸ Ù…Ø­ØµÙˆÙ„ Ù†Ù‡Ø§ÛŒÛŒ:*\\n${project.finalProduct}\\n\\n`;\n  }\n  \n  if (project.status) {\n    msg += `*ğŸ“Š ÙˆØ¶Ø¹ÛŒØª:*\\n${project.status}\\n\\n`;\n  }\n  \n  if (project.publishDate) {\n    msg += `*ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±:* ${project.publishDate}\\n`;\n  }\n  \n  if (project.deadline) {\n    msg += `*â° Ù…Ù‡Ù„Øª Ù¾Ø°ÛŒØ±Ø´:* ${project.deadline}\\n`;\n  }\n  \n  msg += `\\nğŸ”— [Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª ØªÙˆØ§Ù†ÛŒØ±](https://satab.tavanir.org.ir/)\\n\\n`;\n  msg += `_ğŸ¤– Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ ${toFaDigits(index + 1)} Ø§Ø² ${toFaDigits(newProjects.length)}_`;\n  \n  messages.push({\n    json: {\n      send: true,\n      message: msg,\n      messageType: 'new',\n      project: project,\n      index: messages.length\n    }\n  });\n});\n\n// Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡\nupdatedProjects.forEach((project, index) => {\n  let msg = `ğŸ”„ *Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÙˆÙ„ÙˆÛŒØª ØªØ­Ù‚ÛŒÙ‚Ø§ØªÛŒ*\\n\\n`;\n  \n  if (project.title) {\n    msg += `*ğŸ“Œ Ø¹Ù†ÙˆØ§Ù†:*\\n${project.title}\\n\\n`;\n  }\n  \n  if (project.company) {\n    msg += `*ğŸ¢ Ø´Ø±Ú©Øª:* ${project.company}\\n\\n`;\n  }\n  \n  msg += `*âœï¸ ØªØºÛŒÛŒØ±Ø§Øª:*\\n`;\n  \n  project.changes.forEach(change => {\n    msg += `\\nâ–«ï¸ *${change.field}*\\n`;\n    msg += `   Ù‚Ø¨Ù„ÛŒ: ${change.oldValue || 'Ø®Ø§Ù„ÛŒ'}\\n`;\n    msg += `   Ø¬Ø¯ÛŒØ¯: ${change.newValue || 'Ø®Ø§Ù„ÛŒ'} âœ¨\\n`;\n  });\n  \n  msg += `\\n*ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ ÙØ¹Ù„ÛŒ:*\\n\\n`;\n  \n  if (project.mainAxis) {\n    msg += `*ğŸ¯ Ù…Ø­ÙˆØ±:* ${project.mainAxis}\\n`;\n  }\n  \n  if (project.status) {\n    msg += `*ğŸ“Š ÙˆØ¶Ø¹ÛŒØª:* ${project.status}\\n`;\n  }\n  \n  if (project.deadline) {\n    msg += `*â° Ù…Ù‡Ù„Øª:* ${project.deadline}\\n`;\n  }\n  \n  msg += `\\nğŸ”— [Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª ØªÙˆØ§Ù†ÛŒØ±](https://satab.tavanir.org.ir/)\\n\\n`;\n  msg += `_ğŸ¤– Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù‡ ${toFaDigits(index + 1)} Ø§Ø² ${toFaDigits(updatedProjects.length)}_`;\n  \n  messages.push({\n    json: {\n      send: true,\n      message: msg,\n      messageType: 'updated',\n      project: project,\n      index: messages.length\n    }\n  });\n});\n\nreturn messages;"
      },
      "id": "code-format-messages",
      "name": "Format Telegram Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.send }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "if-should-send",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        460,
        400
      ]
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "seconds"
      },
      "id": "wait-between-msgs",
      "name": "Wait Between Messages",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        680,
        400
      ],
      "webhookId": "wait-tavanir-messages"
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID_HERE",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        900,
        400
      ],
      "id": "telegram-send",
      "name": "Send to Telegram",
      "credentials": {
        "telegramApi": {
          "id": "YOUR_TELEGRAM_CREDENTIALS_ID",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Every 12 Hours": {
      "main": [
        [
          {
            "node": "Fetch Companies List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Companies List": {
      "main": [
        [
          {
            "node": "Filter Khorasan Companies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Khorasan Companies": {
      "main": [
        [
          {
            "node": "Fetch Projects for Company",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Projects for Company": {
      "main": [
        [
          {
            "node": "Merge Company Info with Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Company Info with Response": {
      "main": [
        [
          {
            "node": "Parse Projects Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Projects Data": {
      "main": [
        [
          {
            "node": "Merge All Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Projects": {
      "main": [
        [
          {
            "node": "Detect Changes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect Changes": {
      "main": [
        [
          {
            "node": "Format Telegram Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Telegram Messages": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "Wait Between Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Between Messages": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "tavanir-priorities-v1",
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "research-priorities-khorasan"
  },
  "id": "ResearchPrioritiesTavanirKhorasan",
  "tags": [
    "research",
    "priorities",
    "tavanir",
    "khorasan",
    "telegram",
    "power-industry"
  ]
}
