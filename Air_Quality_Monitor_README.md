# ุฑุงูููุง ุงุณุชูุงุฏู ุงุฒ Workflow ฺฉูุช ููุง

ุงู workflow ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ูุฑ ุณุงุนุช ุฏุงุฏูโูุง ฺฉูุช ููุง (AQI) ุฑุง ุงุฒ ุณุงุช ุณุงุฒูุงู ูุญุท ุฒุณุช ุฏุฑุงูุช ฺฉุฑุฏู ู ุฎูุงุตูโุง ุงุฒ ูุถุนุช ุฑุง ุจู ฺฉุงูุงู ุชูฺฏุฑุงู ุงุฑุณุงู ูโฺฉูุฏ.

## ๐ ููุฑุณุช ูุทุงูุจ
- [ูุนูุงุฑ Workflow](#ูุนูุงุฑ-workflow)
- [ูพุดโูุงุฒูุง](#ูพุดูุงุฒูุง)
- [ูุตุจ ู ุฑุงูโุงูุฏุงุฒ](#ูุตุจ-ู-ุฑุงูุงูุฏุงุฒ)
- [ุชูุถุญ Nodeโูุง](#ุชูุถุญ-nodeูุง)
- [ููููู ุฎุฑูุฌ](#ููููู-ุฎุฑูุฌ)
- [ุนุจโุงุจ](#ุนุจุงุจ)

## ๐๏ธ ูุนูุงุฑ Workflow

```
Cron Trigger (ูุฑ ุณุงุนุช)
    โโโ> Get Stations (HTTP Request)
    โ         โ
    โ         โโโ> Merge Stations & AQI (Function)
    โ                     โ
    โโโ> Get AQI (HTTP Request)โโโ
                                  โ
                                  โโโ> Duplicate Prevention (Function)
                                           โ
                                           โโโ> Should Send? (IF)
                                                    โ
                                                    โโโ> Send to Telegram
```

## ๐ฆ ูพุดโูุงุฒูุง

### 1. ูุชุบุฑูุง ูุญุท (Environment Variables)

ุฏุฑ n8n ุฎูุฏ ุจุงุฏ ูุชุบุฑูุง ุฒุฑ ุฑุง ุชูุธู ฺฉูุฏ:

```bash
AQMS_BEARER=your_bearer_token_here
TELEGRAM_CHAT_ID=@your_channel_or_chat_id
```

#### ูุญูู ุฏุฑุงูุช AQMS_BEARER:

1. ุจู ุณุงุช https://aqms.doe.ir ุจุฑูุฏ
2. DevTools ูุฑูุฑฺฏุฑ ุฑุง ุจุงุฒ ฺฉูุฏ (F12)
3. ุจู ุชุจ Network ุจุฑูุฏ
4. ฺฉ ุฏุฑุฎูุงุณุช API ุฑุง ุงูุฌุงู ุฏูุฏ
5. ุฏุฑ Headers ุฏุฑุฎูุงุณุชุ ููุฏุงุฑ `Authorization: Bearer ...` ุฑุง ฺฉูพ ฺฉูุฏ

### 2. Telegram Bot Credentials

ุฏุฑ n8n:
1. ุจู Settings โ Credentials ุจุฑูุฏ
2. ฺฉ credential ุฌุฏุฏ ุงุฒ ููุน "Telegram API" ุงุฌุงุฏ ฺฉูุฏ
3. Access Token ุฑุจุงุช ุชูฺฏุฑุงู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ (ุงุฒ @BotFather ุฏุฑุงูุช ูโุดูุฏ)

## ๐ ูุตุจ ู ุฑุงูโุงูุฏุงุฒ

### ฺฏุงู 1: Import ฺฉุฑุฏู Workflow

1. ูุงู `Air_Quality_Monitor.json` ุฑุง ุจุงุฒ ฺฉูุฏ
2. ุฏุฑ n8n ุจู ูุณูุช Workflows ุจุฑูุฏ
3. ุฑู "Import from File" ฺฉูฺฉ ฺฉูุฏ
4. ูุงู JSON ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

### ฺฏุงู 2: ุชูุธู Credentials

1. ุฑู node "Send to Telegram" ฺฉูฺฉ ฺฉูุฏ
2. Telegram Bot credential ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

### ฺฏุงู 3: ุชูุธู Environment Variables

**ุฑูุด 1: ุงุณุชูุงุฏู ุงุฒ ูุงู .env.example ููุฌูุฏ**

1. ูุงู `.env.example` ุฑุง ฺฉูพ ฺฉูุฏ ู ูุงู ุขู ุฑุง ุจู `.env` ุชุบุฑ ุฏูุฏ
2. ุชูฺฉู Bearer ูุจูุงู ุฏุฑ ูุงู ูุฑุงุฑ ุฏุงุฏู ุดุฏู ุงุณุช
3. ููุท ููุฏุงุฑ `TELEGRAM_CHAT_ID` ุฑุง ุจุง ุดูุงุณู ฺฉุงูุงู/ฺุช ุฎูุฏ ุฌุงฺฏุฒู ฺฉูุฏ

**ุฑูุด 2: ุชูุธู ูุณุชูู ุฏุฑ n8n**

ุฏุฑ n8n ุจู ูุณุฑ ุฒุฑ ุจุฑูุฏ:
- Settings โ Environments โ Add Variable

ูุชุบุฑูุง ููุฑุฏ ูุงุฒ:

```env
AQMS_BEARER=PD-jvbkAgKdeLFivtcSyxsJxt3WG94u59PMTNWccp9EXI7yO5Zg6ET8I2p0gACOpDbI6jdFVkl2pVZPwhuxZFWTo5W67YK9liE9sAcJWqzK30TmD-XMYKUUgUiXgA1PrytYyTsuTUF72NmZ7RorFLueMJNGrywYuUhAv0XRbLIcFQH123JCvahFzU29HF9SGVu-fAVx68mVzQlwdcfjSfM6CFaLuWdBg6VK5bWKUV837jv7nTESLate0huP7_HVdQ3F8kwR_0_TNdmocePsfb4KaNLl9zgzfoyoE5aSK6JDGJvVZ3Zb6_jEQ5mdVlQbj
TELEGRAM_CHAT_ID=@your_channel
```

**โ๏ธ ูฺฉุชู ุงููุช**: ุงู ุชูฺฉู ุจุฑุง ุงุณุชูุงุฏู ุดุฎุต ุดูุง ุงุณุช. ุขู ุฑุง ุจุง ุฏฺฏุฑุงู ุจู ุงุดุชุฑุงฺฉ ูฺฏุฐุงุฑุฏ.

### ฺฏุงู 4: ูุนุงูโุณุงุฒ Workflow

1. ุฑู ุฏฺฉูู "Active" ุฏุฑ ุจุงูุง workflow ฺฉูฺฉ ฺฉูุฏ
2. Workflow ูุฑ ุณุงุนุช ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ

### ฺฏุงู 5: ุชุณุช ุฏุณุช

ุจุฑุง ุชุณุชุ ุฑู node "Every Hour" ฺฉูฺฉ ุฑุงุณุช ฺฉุฑุฏู ู "Execute Node" ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.

## ๐ง ุชูุถุญ Nodeโูุง

### 1. Every Hour (Cron Trigger)
- **ููุน**: Schedule Trigger
- **ุชูุธูุงุช**: ูุฑ ุณุงุนุชุ ุฏุฑ ุฏููู 0
- **ุฎุฑูุฌ**: ฺฉ trigger ุจุฑุง ุดุฑูุน workflow

### 2. Get Stations (HTTP Request)
- **URL**: `https://aqms.doe.ir/Service/api/v2/Station/GetStationsByStateId/?StateId=8`
- **Method**: GET
- **Headers**:
  - `Accept: application/json`
  - `Authorization: Bearer {{$env.AQMS_BEARER}}`
- **ุฎุฑูุฌ**: ูุณุช ุงุณุชฺฏุงูโูุง ุณูุฌุด ฺฉูุช ููุง ุฏุฑ ุฎุฑุงุณุงู ุฑุถู

### 3. Get AQI (HTTP Request)
- **URL**: `https://aqms.doe.ir/Service/api/v2/AQI/Get/?StateId=8`
- **Method**: GET
- **Headers**: ููุงููุฏ Get Stations
- **ุฎุฑูุฌ**: ุฏุงุฏูโูุง AQI ูุนู ุจุฑุง ูุฑ ุงุณุชฺฏุงู

### 4. Merge Stations & AQI (Function)
ุงู node:
- ุฏุงุฏูโูุง ุฏู API ุฑุง ุจุง ูู ุชุฑฺฉุจ ูโฺฉูุฏ
- ุงุนุฏุงุฏ ูุงุฑุณ ุฑุง ุจู ุงูฺฏูุณ ุชุจุฏู ูโฺฉูุฏ (normalize)
- ุงุณุชฺฏุงูโูุง ุฑุง ุจุฑ ุงุณุงุณ AQI ูุฑุชุจ ูโฺฉูุฏ
- ูพุงู ููุง ุฑุง ุจุง ูุฑูุช Markdown ูโุณุงุฒุฏ

**ุฎุฑูุฌ**:
```json
{
  "merged": [...],  // ุขุฑุงู ฺฉุงูู ุงุณุชฺฏุงูโูุง
  "summary": {
    "updated_at": "2025-10-30T12:00:00.000Z",
    "total_stations": 24,
    "top5": [...]
  },
  "message": "ูุชู ูพุงู Markdown"
}
```

### 5. Duplicate Prevention (Function)
- ุงุฒ Workflow Static Data ุงุณุชูุงุฏู ูโฺฉูุฏ
- ุฒูุงู ุขุฎุฑู ุงุฑุณุงู ุฑุง ุฐุฎุฑู ูโฺฉูุฏ
- ุงฺฏุฑ ุฏุงุฏู ุฌุฏุฏ ุจุงุดุฏุ `send: true` ุจุฑูโฺฏุฑุฏุงูุฏ
- ุงุฒ ุงุฑุณุงู ุชฺฉุฑุงุฑ ุฌููฺฏุฑ ูโฺฉูุฏ

### 6. Should Send? (IF)
- ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง `send === true`
- ุงฺฏุฑ true ุจุงุดุฏุ ุจู node ุชูฺฏุฑุงู ูโุฑูุฏ
- ุงฺฏุฑ false ุจุงุดุฏุ workflow ูุชููู ูโุดูุฏ

### 7. Send to Telegram
- ูพุงู ุฑุง ุจู ฺฉุงูุงู/ฺุช ูุดุฎุต ุดุฏู ุงุฑุณุงู ูโฺฉูุฏ
- ุงุฒ ูุฑูุช Markdown ุงุณุชูุงุฏู ูโฺฉูุฏ
- ูพุดโููุงุด ููฺฉ ุบุฑูุนุงู ุงุณุช

## ๐ฑ ููููู ุฎุฑูุฌ

```
*ุดุงุฎุต ฺฉูุช ููุง โ ุฎูุงุตู (ุฎุฑุงุณุงู ุฑุถู)*
ุฒูุงู ุจุฑูุฒุฑุณุงู: ฑดฐด/ฐท/ณฐ ฐน:ฐฐ
ุชุนุฏุงุฏ ุงุณุชฺฏุงูโูุง: ฒด

*ูพูุฌ ุงุณุชฺฏุงู ุจุง ุจุฏุชุฑู ูุถุนุช (AQI):*
1. *ูุดูุฏ - ุฑุณุงูุช* โ ุดุงุฎุต: *ฑธด* โ ุขูุงูุฏูโ ุบุงูุจ: PM10
2. *ูุดูุฏ - ุณุฌุงุฏ* โ ุดุงุฎุต: *ฑถท* โ ุขูุงูุฏูโ ุบุงูุจ: PM2.5
3. *ูุดูุฏ - ฺฉููุณูฺฏ* โ ุดุงุฎุต: *ฑตฒ*
4. *ูุดูุฏ - ูฺฉูโุขุจุงุฏ* โ ุดุงุฎุต: *ฑดต*
5. *ูุดุงุจูุฑ* โ ุดุงุฎุต: *ฑฒณ*

_ูพุงู ุฎูุฏฺฉุงุฑ โ ูุฑ ุณุงุนุช ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ._
```

## ๐ ุนุจโุงุจ

### ุฎุทุง: "Bearer token is invalid"
**ุฑุงู ุญู**: ุชูฺฉู ูููุถ ุดุฏู ุงุณุช. ฺฉ ุชูฺฉู ุฌุฏุฏ ุงุฒ DevTools ุฏุฑุงูุช ฺฉูุฏ.

### ุฎุทุง: "Could not reach URL"
**ุฑุงู ุญู**:
- ุงุชุตุงู ุงูุชุฑูุช ุฑุง ุจุฑุฑุณ ฺฉูุฏ
- VPN ุง ูพุฑูฺฉุณ ุฑุง ูุนุงู ฺฉูุฏ (ุงฺฏุฑ ูุงุฒู ุงุณุช)

### ุฎุทุง: "Chat not found"
**ุฑุงู ุญู**:
- TELEGRAM_CHAT_ID ุฑุง ุจุฑุฑุณ ฺฉูุฏ
- ูุทูุฆู ุดูุฏ ุฑุจุงุช ุจู ฺฉุงูุงู ุงุถุงูู ุดุฏู ุงุณุช
- ุงฺฏุฑ ุงุฒ ุนุฏุฏ ุงุณุชูุงุฏู ูโฺฉูุฏุ ุนูุงูุช `-` ุฑุง ูุฑุงููุด ูฺฉูุฏ (ูุซูุงู `-1001234567890`)

### ูพุงู ุงุฑุณุงู ููโุดูุฏ
**ุฑุงู ุญู**:
- Workflow Static Data ุฑุง ูพุงฺฉ ฺฉูุฏ (Settings โ Reset Static Data)
- Node "Duplicate Prevention" ุฑุง ูููุชุงู ุญุฐู ฺฉูุฏ
- ูุณุชููุงู ุงุฒ "Merge Stations & AQI" ุจู "Should Send?" ูุตู ฺฉูุฏ

### ุงุนุฏุงุฏ ูุงุฑุณ ุจู ุฏุฑุณุช ููุงุด ุฏุงุฏู ููโุดููุฏ
**ุฑุงู ุญู**: ุชุงุจุน `persianNumber` ุฏุฑ node "Merge Stations & AQI" ุงุนุฏุงุฏ ุงูฺฏูุณ ุฑุง ุจู ูุงุฑุณ ุชุจุฏู ูโฺฉูุฏ. ฺฉุฏ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.

## ๐๏ธ ุณูุงุฑุดโุณุงุฒ

### ุชุบุฑ ุชุนุฏุงุฏ ุงุณุชฺฏุงูโูุง ููุงุด ุฏุงุฏู ุดุฏู
ุฏุฑ node "Merge Stations & AQI":
```javascript
const top5 = sorted.slice(0, 5);  // ุชุบุฑ 5 ุจู ุชุนุฏุงุฏ ุฏูุฎูุงู
```

### ุชุบุฑ ูุฑูุช ูพุงู
ุฏุฑ ููุงู nodeุ ูุณูุช `let message = ...` ุฑุง ูุฑุงุด ฺฉูุฏ.

### ุชุบุฑ ุฒูุงู ุงุฌุฑุง
ุฏุฑ node "Every Hour":
- ุจุฑุง ุงุฌุฑุง ูุฑ 30 ุฏููู: Minutes interval = 30
- ุจุฑุง ุงุฌุฑุง ุฑูุฒุงูู: Hours interval = 24

### ุงูุฒูุฏู ููุชุฑ ุขุณุชุงูู
ุจุฑุง ุงุฑุณุงู ููุท ุฒูุงู ฺฉู AQI ุจุงูุงุชุฑ ุงุฒ 150 ุงุณุช:
```javascript
// ุฏุฑ node "Merge Stations & AQI"
const hasHighAQI = top5.some(s => s.aqi_now > 150);
return [{ json: { merged, summary, message, shouldAlert: hasHighAQI } }];
```

ุณูพุณ ุฏุฑ node "Should Send?" ุดุฑุท ุฑุง ุชุบุฑ ุฏูุฏ:
```
$json.send === true AND $json.shouldAlert === true
```

## ๐ ุฐุฎุฑู ุฏุงุฏูโูุง ุชุงุฑุฎ

ุงฺฏุฑ ูโุฎูุงูุฏ ุฏุงุฏูโูุง ุฑุง ุฐุฎุฑู ฺฉูุฏ:

1. ฺฉ node "Google Sheets" ุง "Database" ุงุถุงูู ฺฉูุฏ
2. ุจุนุฏ ุงุฒ "Merge Stations & AQI" ูุตู ฺฉูุฏ
3. ููุฏ `merged` ุฑุง ุฏุฑ ุขู ุฐุฎุฑู ฺฉูุฏ

## ๐ ุงุฏุฏุงุดุชโูุง

- **StateId=8**: ุฎุฑุงุณุงู ุฑุถู. ุจุฑุง ุงุณุชุงูโูุง ุฏฺฏุฑ ุงู ูพุงุฑุงูุชุฑ ุฑุง ุชุบุฑ ุฏูุฏ
- **Rate Limiting**: ุจุง ุงุฌุฑุง ูุฑ ุณุงุนุชุ ูุดฺฉู ุจุง rate limit ูุฎูุงูุฏ ุฏุงุดุช
- **ุชูฺฉู**: ุจู ุทูุฑ ูุนููู ุชูฺฉูโูุง Bearer ุจุนุฏ ุงุฒ ฺูุฏ ุณุงุนุช ูููุถ ูโุดููุฏ
- **Timezone**: ุฒูุงู ููุงุด ุจุง locale ุณุฑูุฑ ุดูุง ูุทุงุจูุช ุฏุงุฑุฏ

## ๐ ุงููุช

- โ๏ธ ุชูฺฉูโูุง ุฑุง ูุฑฺฏุฒ ุฏุฑ ฺฉุฏ ูุงุฑุฏฺฉุฏ ูฺฉูุฏ
- โ ุงุฒ Environment Variables ุงุณุชูุงุฏู ฺฉูุฏ
- โ ุฏุณุชุฑุณ ุจู workflow ุฑุง ูุญุฏูุฏ ฺฉูุฏ
- โ ุชูฺฉู ุฑุง ุจู ุตูุฑุช ุฏูุฑูโุง ุชุบุฑ ุฏูุฏ

## ๐ ูพุดุชุจุงู

ุงฺฏุฑ ูุดฺฉู ุฏุงุดุชุฏ:
1. ูุงฺฏโูุง execution ุฑุง ุจุฑุฑุณ ฺฉูุฏ (ฺฉูฺฉ ุฑู ูุฑ node ู ูุดุงูุฏู Output)
2. Console logs ุฑุง ุฏุฑ nodeโูุง Function ุจุฑุฑุณ ฺฉูุฏ
3. ุงุฒ ูุงุจูุช "Execute Node" ุจุฑุง ุชุณุช ุชฺฉโุชฺฉ nodeโูุง ุงุณุชูุงุฏู ฺฉูุฏ

---

**ูุณุฎู**: 1.0
**ุชุงุฑุฎ**: ฑดฐด/ฐท/ณฐ
**ุณุงุฒูุฏู**: Claude Code
